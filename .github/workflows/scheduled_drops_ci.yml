name: scheduled_drops_ci

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

jobs:
  ci_scheduled_drops:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      PYTHONUNBUFFERED: "1"
      MGC_NO_COLOR: "1"

      # CI must be self-contained and never depend on riffusion or repo-stored audio.
      MGC_PROVIDER: "stub"
      MGC_DETERMINISTIC: "1"
      MGC_FIXED_TIME: "2020-01-01T00:00:00Z"

      # Force any default outputs away from the repo so "git clean" checks don't fail.
      MGC_ARTIFACTS_DIR: "/tmp/mgc_artifacts"
      MGC_EVIDENCE_DIR: "/tmp/mgc_evidence"
      MGC_TRACKS_DIR: "/tmp/mgc_tracks"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Compile check
        shell: bash
        run: |
          set -euxo pipefail
          python -m py_compile src/mgc/main.py
          python -m py_compile src/mgc/run_cli.py
          python -m py_compile src/mgc/web_cli.py

      - name: Run weekly (stub) + verify playlist track files + build web
        shell: bash
        run: |
          set -euxo pipefail

          OUT="/tmp/mgc_ci_weekly"
          WEB_OUT="/tmp/mgc_ci_web"

          rm -rf "$OUT" "$WEB_OUT" /tmp/mgc_artifacts /tmp/mgc_evidence /tmp/mgc_tracks
          mkdir -p "$OUT" /tmp/mgc_artifacts /tmp/mgc_evidence /tmp/mgc_tracks

          python -m mgc.main \
            --db fixtures/ci_db.sqlite \
            --seed 1 \
            --no-resume \
            run weekly \
              --context focus \
              --period-key 2020-W01 \
              --out-dir "$OUT" \
              --deterministic \
              --web \
              --submission

          test -s "$OUT/drop_bundle/playlist.json"

          cat > /tmp/check_playlist_tracks.py <<'PY'
import json
import os
import sys

PLAYLIST = "/tmp/mgc_ci_weekly/drop_bundle/playlist.json"

with open(PLAYLIST, "r", encoding="utf-8") as f:
    obj = json.load(f)

base = os.path.dirname(PLAYLIST)
tracks = obj.get("tracks") or []

def get_path(t):
    for k in ("path", "file", "audio_path", "audio", "src"):
        v = t.get(k)
        if isinstance(v, str) and v.strip():
            return v.strip()
    return ""

missing = []
for t in tracks:
    if not isinstance(t, dict):
        continue
    path = get_path(t)
    if not path:
        continue
    resolved = path if os.path.isabs(path) else os.path.normpath(os.path.join(base, path))
    if not os.path.exists(resolved):
        missing.append({"track_id": t.get("id"), "path": path, "resolved": resolved})

if missing:
    print("ERROR: playlist references missing track files:")
    for m in missing[:200]:
        print(m)
    sys.exit(2)

print("OK: all playlist track files exist")
PY

          python /tmp/check_playlist_tracks.py

          rm -rf "$WEB_OUT"
          python -m mgc.main web build \
            --playlist "$OUT/drop_bundle/playlist.json" \
            --out-dir "$WEB_OUT" \
            --prefer-mp3 \
            --clean \
            --fail-if-empty \
            --json

          python -m mgc.main web validate --out-dir "$WEB_OUT"

      - name: Upload CI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mgc_ci_weekly
          path: |
            /tmp/mgc_ci_weekly
            /tmp/mgc_ci_web
          if-no-files-found: error

name: scheduled_drops_ci

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
  schedule:
    - cron: "0 6 * * *"

jobs:
  scheduled_drops_ci:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      PYTHONUNBUFFERED: "1"
      MGC_NO_COLOR: "1"

      # CI must never assume repo-stored audio exists.
      # Use stub so itâ€™s deterministic and self-contained.
      MGC_PROVIDER: "stub"

      # Keep any accidental outputs away from the repo checkout
      MGC_ARTIFACTS_DIR: "/tmp/mgc_ci_artifacts"
      MGC_EVIDENCE_DIR: "/tmp/mgc_ci_evidence"
      MGC_TRACKS_DIR: "/tmp/mgc_ci_tracks"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare venv
        shell: bash
        run: |
          set -euxo pipefail
          python3 -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Run autonomous (self-contained) and build web
        shell: bash
        run: |
          set -euxo pipefail
          . .venv/bin/activate

          OUT="/tmp/mgc_ci_autonomous"
          WEB_OUT="/tmp/mgc_ci_web"

          rm -rf "$OUT" "$WEB_OUT" /tmp/mgc_ci_artifacts /tmp/mgc_ci_evidence /tmp/mgc_ci_tracks
          rm -rf data/evidence tracks || true
          mkdir -p /tmp/mgc_ci_artifacts /tmp/mgc_ci_evidence /tmp/mgc_ci_tracks

          python -m mgc.main \
            --db fixtures/ci_db.sqlite \
            --seed 1 \
            --no-resume \
            run autonomous \
              --context focus \
              --out-dir "$OUT" \
              --deterministic \
              --with-web

          test -s "$OUT/drop_bundle/playlist.json"

          # Assert playlist track files exist inside OUT
          python scripts/check_playlist_tracks.py "$OUT/drop_bundle/playlist.json" "$OUT"

          # Build a separate web bundle (CI sanity)
          python -m mgc.main web build \
            --playlist "$OUT/drop_bundle/playlist.json" \
            --out-dir "$WEB_OUT" \
            --prefer-mp3 \
            --clean \
            --fail-if-empty \
            --json

          python -m mgc.main web validate --out-dir "$WEB_OUT"

          # Sanity: web bundle must contain audio
          test "$(find "$WEB_OUT" -maxdepth 8 -type f \( -name '*.mp3' -o -name '*.wav' \) | wc -l | tr -d ' ')" != "0"

      - name: Repo must remain clean
        shell: bash
        run: |
          set -euxo pipefail
          rm -rf data/evidence tracks || true
          test -z "$(git status --porcelain)"

name: scheduled_drops_ci

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

jobs:
  scheduled_drops_ci:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      PYTHONUNBUFFERED: "1"
      MGC_NO_COLOR: "1"

      MGC_PROVIDER: "stub"
      MGC_DETERMINISTIC: "1"
      MGC_FIXED_TIME: "2020-01-01T00:00:00Z"

      MGC_ARTIFACTS_DIR: "/tmp/mgc_artifacts"
      MGC_EVIDENCE_DIR: "/tmp/mgc_evidence"
      MGC_TRACKS_DIR: "/tmp/mgc_tracks"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clean repo working tree
        shell: bash
        run: |
          set -euxo pipefail
          rm -rf data/evidence tracks || true
          git clean -fdx

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install editable
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Run autonomous (stub) + build web + validate
        shell: bash
        run: |
          set -euxo pipefail

          OUT="/tmp/mgc_ci_autonomous"
          WEB_OUT="/tmp/mgc_ci_web"
          DB_TMP="/tmp/mgc_ci_db.sqlite"

          rm -rf "$OUT" "$WEB_OUT" /tmp/mgc_artifacts /tmp/mgc_evidence /tmp/mgc_tracks
          rm -rf data/evidence tracks || true
          mkdir -p "$OUT" /tmp/mgc_artifacts /tmp/mgc_evidence /tmp/mgc_tracks

          cp -f fixtures/ci_db.sqlite "$DB_TMP"

          python -m mgc.main \
            --db "$DB_TMP" \
            --seed 1 \
            --no-resume \
            run autonomous \
              --context focus \
              --out-dir "$OUT" \
              --deterministic \
              --with-web

          test -s "$OUT/drop_bundle/playlist.json"

          python -m mgc.main web build \
            --playlist "$OUT/drop_bundle/playlist.json" \
            --out-dir "$WEB_OUT" \
            --prefer-mp3 \
            --clean \
            --fail-if-empty \
            --json

          python -m mgc.main web validate --out-dir "$WEB_OUT"

          rm -rf data/evidence tracks || true
          test -z "$(git status --porcelain)"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mgc_ci_autonomous
          path: |
            /tmp/mgc_ci_autonomous
            /tmp/mgc_ci_web
          if-no-files-found: error

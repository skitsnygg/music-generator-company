name: CI

on:
  push:
    branches: ["**"]
  pull_request:

permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      # Use built-in runner env var (works everywhere) instead of ${{ runner.temp }}
      MGC_ARTIFACTS_DIR: ${{ env.RUNNER_TEMP }}/artifacts/ci
      MGC_DB: ${{ env.RUNNER_TEMP }}/ci_db.sqlite
      # Optional: enforce "golden" submission.zip hashes.
      # Set to "1" (or "true") to fail if the submission.zip sha isn't in ci/known_good_submission_sha256.txt
      MGC_GOLDEN_STRICT: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      # Cache your deterministic rebuild outputs (big speed win once stable)
      - name: Cache CI artifacts (rebuild outputs)
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.MGC_ARTIFACTS_DIR }}/rebuild
          key: ${{ runner.os }}-mgc-rebuild-${{ hashFiles('src/**/*.py', 'scripts/**/*.sh', 'fixtures/**/*.sqlite', 'pyproject.toml', 'requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-mgc-rebuild-

      - name: Seed CI DB
        run: |
          cp fixtures/ci_db.sqlite "${MGC_DB}"

      - name: Run CI gate
        run: |
          bash scripts/ci_gate.sh

      # Optional golden hash enforcement (warn by default; strict if env set)
      - name: Golden hash gate (submission.zip)
        if: always()
        run: |
          set -euo pipefail
          MODE="warn"
          v="${MGC_GOLDEN_STRICT:-0}"
          if [ "$v" = "1" ] || [ "$v" = "true" ] || [ "$v" = "yes" ]; then
            MODE="strict"
          fi
          bash scripts/ci_golden_hash_gate.sh \
            --evidence-root "${MGC_ARTIFACTS_DIR}/auto" \
            --known-file "ci/known_good_submission_sha256.txt" \
            --mode "$MODE"

      # Upload the exact artifacts CI produced (submission.zip + receipt + web bundle + logs)
      - name: Upload CI artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mgc-ci-artifacts
          if-no-files-found: warn
          retention-days: 14
          path: |
            ${{ env.MGC_ARTIFACTS_DIR }}/**
            data/submissions/**

      # Also upload a tight “release bundle” (submission.zip + receipt + web) derived from evidence
      - name: Upload submission bundle (from evidence)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mgc-submission-bundle
          if-no-files-found: warn
          retention-days: 14
          path: |
            ${{ env.MGC_ARTIFACTS_DIR }}/auto/drop_evidence.json
            ${{ env.MGC_ARTIFACTS_DIR }}/auto/manifest.json
            ${{ env.MGC_ARTIFACTS_DIR }}/auto/playlist.json
            ${{ env.MGC_ARTIFACTS_DIR }}/auto/tracks/**
            ${{ env.MGC_ARTIFACTS_DIR }}/auto/*.log
            data/submissions/**/submission.zip
            data/submissions/**/submission.receipt.json
            data/submissions/**/web/**

name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      MGC_DB: fixtures/ci_db.sqlite

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare artifacts dir (always)
        run: |
          set -euxo pipefail
          mkdir -p artifacts/ci
          echo "placeholder" > artifacts/ci/.keep
          ls -la artifacts/ci

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -euxo pipefail
          python -m pip install -U pip
          pip install -e .

      - name: Build fixture DB
        run: |
          set -euxo pipefail
          python scripts/make_fixture_db.py
          ls -la fixtures

      - name: CI DB preflight
        run: |
          set -euxo pipefail
          echo "MGC_DB=$MGC_DB"
          python -c "import os, sqlite3; p=os.environ['MGC_DB']; con=sqlite3.connect(p); print(con.execute(\"select name from sqlite_master where type='table' order by name\").fetchall()); con.close()"

      - name: Rebuild verify
        run: |
          set -euxo pipefail
          bash scripts/ci_rebuild_verify.sh

      - name: CI schema audit
        run: |
          set -euxo pipefail
          ./scripts/ci_schema_audit.py \
            --db fixtures/ci_db.sqlite \
            --py src/mgc/db_helpers.py \
            --py src/mgc/events.py \
            --py src/mgc/rebuild_cli.py \
            --py src/mgc/db.py \
            --py src/mgc/main.py

      - name: Debug CI scripts (show versions)
        run: |
          set -euxo pipefail
          git rev-parse HEAD
          ls -la scripts/ci_gate.sh scripts/ci_rebuild_verify.sh
          echo "---- ci_gate.sh (first 160 lines) ----"
          sed -n '1,160p' scripts/ci_gate.sh
          echo "---- ci_rebuild_verify.sh (first 220 lines) ----"
          sed -n '1,220p' scripts/ci_rebuild_verify.sh
          echo "---- env (MGC_DB/CI) ----"
          env | sort | grep -E '^(MGC_DB|CI|GITHUB)=' || true

      - name: Run CI gate
        run: |
          set -euxo pipefail
          bash scripts/ci_gate.sh

      - name: Upload CI artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts
          path: artifacts/ci
          if-no-files-found: warn

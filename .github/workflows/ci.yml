name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      MGC_DB: fixtures/ci_db.sqlite

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare artifacts dir (always)
        run: |
          set -euxo pipefail
          mkdir -p artifacts/ci
          echo "placeholder" > artifacts/ci/.keep
          ls -la artifacts/ci

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -euxo pipefail
          python -m pip install -U pip
          pip install -e .

      - name: Build fixture DB
        run: |
          set -euxo pipefail
          python scripts/make_fixture_db.py
          ls -la fixtures

      - name: Preflight DB + scripts (must pass)
        run: |
          set -euxo pipefail
          echo "HEAD=$(git rev-parse HEAD)"
          echo "MGC_DB=$MGC_DB"
          
          echo "---- scripts (head) ----"
          sed -n '1,120p' scripts/ci_gate.sh
          sed -n '1,160p' scripts/ci_rebuild_verify.sh
          
          echo "---- sqlite tables ----"
          python - <<'PY'
          import os, sqlite3, sys
          p = os.environ["MGC_DB"]
          con = sqlite3.connect(p)
          try:
              tables = [r[0] for r in con.execute("select name from sqlite_master where type='table' order by name").fetchall()]
              print("tables:", sorted(tables))
              if "playlists" not in tables:
                  print(f"ERROR: {p} missing playlists table", file=sys.stderr)
                  sys.exit(1)
          finally:
              con.close()
          PY

      - name: Run CI gate (with exported MGC_DB)
        run: |
          set -euxo pipefail
          export MGC_DB="$MGC_DB"
          bash scripts/ci_gate.sh

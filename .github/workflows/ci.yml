name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      MGC_DB: fixtures/ci_db.sqlite

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare artifacts dir (always)
        run: |
          set -euxo pipefail
          mkdir -p artifacts/ci
          echo "placeholder" > artifacts/ci/.keep
          ls -la artifacts/ci

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -euxo pipefail
          python -m pip install -U pip
          pip install -e .

      - name: Build fixture DB
        run: |
          set -euxo pipefail
          python scripts/make_fixture_db.py
          ls -la fixtures

      - name: Debug checked-out commit + scripts + DB
        run: |
          set -euxo pipefail
          echo "HEAD=$(git rev-parse HEAD)"
          git --no-pager log -1 --oneline --decorate
          echo "pwd=$(pwd)"
          echo "MGC_DB=$MGC_DB"
          echo "---- list scripts ----"
          ls -la scripts/ci_gate.sh scripts/ci_rebuild_verify.sh || true
          echo "---- marker grep ----"
          grep -n "MARKER=" scripts/ci_gate.sh scripts/ci_rebuild_verify.sh || true
          echo "---- ci_gate.sh (first 120 lines) ----"
          sed -n '1,120p' scripts/ci_gate.sh || true
          echo "---- ci_rebuild_verify.sh (first 180 lines) ----"
          sed -n '1,180p' scripts/ci_rebuild_verify.sh || true
          echo "---- fixtures dir ----"
          ls -la fixtures || true
          echo "---- sqlite tables (fixture DB) ----"
          python - <<'PY'
          import os, sqlite3
          p = os.environ["MGC_DB"]
          con = sqlite3.connect(p)
          try:
              tables = con.execute("select name from sqlite_master where type='table' order by name").fetchall()
              print("tables:", tables)
          finally:
              con.close()
          PY

      - name: CI schema audit
        run: |
          set -euxo pipefail
          ./scripts/ci_schema_audit.py \
            --db fixtures/ci_db.sqlite \
            --py src/mgc/db_helpers.py \
            --py src/mgc/events.py \
            --py src/mgc/rebuild_cli.py \
            --py src/mgc/db.py \
            --py src/mgc/main.py

      - name: Rebuild verify
        run: |
          set -euxo pipefail
          bash scripts/ci_rebuild_verify.sh

      - name: Run CI gate (authoritative DB env)
        run: |
          set -euxo pipefail

          # Always build the fixture DB in the same step that runs the gate
          python scripts/make_fixture_db.py
          ls -la fixtures

          export MGC_DB=fixtures/ci_db.sqlite
          echo "MGC_DB=$MGC_DB"

          # Prove the DB has the required table BEFORE running the gate
          python - <<'PY'
          import os, sqlite3, sys
          p = os.environ["MGC_DB"]
          con = sqlite3.connect(p)
          try:
              tables = [r[0] for r in con.execute("select name from sqlite_master where type='table'").fetchall()]
              print("tables:", sorted(tables))
              if "playlists" not in tables:
                  print(f"ERROR: {p} has no playlists table", file=sys.stderr)
                  sys.exit(1)
          finally:
              con.close()
          PY

          # Run the gate in this exact environment
          bash scripts/ci_gate.sh
      

      - name: Upload CI artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts
          path: artifacts/ci
          if-no-files-found: warn

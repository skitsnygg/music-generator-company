<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>Music Generator Company — Player</title>
  <style>
    :root{
      --bg: #000000;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.10);
      --border: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.94);
      --muted: rgba(255,255,255,0.62);
      --muted2: rgba(255,255,255,0.45);
      --accent: #7c5cff;
      --accent2: #35d6c7;
      --danger: #ff5c7a;
      --ok: #37d67a;
      --shadow: 0 10px 28px rgba(0,0,0,0.65);
      --radius: 14px;
      --radius2: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: var(--bg);
      color:var(--text);
      font-family:var(--sans);
      line-height:1.35;
    }
    a{ color:inherit; text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .wrap{
      max-width: 1300px;
      margin: 0 auto;
      padding: 22px 16px 40px;
    }
    .top{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 14px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      min-width: 280px;
    }
    .logo{
      width:42px;height:42px;border-radius:12px;
      background: linear-gradient(135deg, rgba(124,92,255,0.95), rgba(53,214,199,0.85));
      box-shadow: var(--shadow);
    }
    .brand h1{
      font-size: 16px;
      margin:0;
      letter-spacing:0.2px;
    }
    .brand .sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .pillbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
    }
    .pill code{
      font-family:var(--mono);
      font-size: 11px;
      color: var(--text);
    }

    .grid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 12px 12px 10px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .cardTitle{
      margin:0;
      font-size: 13px;
      letter-spacing: 0.2px;
    }
    .cardMeta{
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
    }
    .cardBody{
      padding: 12px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .spacer{ flex:1; }

    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding: 9px 11px;
      border-radius: 12px;
      font-size: 12px;
      cursor:pointer;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      display:inline-flex;
      gap: 8px;
      align-items:center;
      justify-content:center;
    }
    .btn:hover{ background: var(--panel2); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(124,92,255,0.55);
      background: rgba(124,92,255,0.12);
    }
    .btn.small{ padding: 7px 9px; border-radius: 10px; }

    .input{
      width:100%;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding: 10px 11px;
      border-radius: 12px;
      font-size: 13px;
      outline:none;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      border-radius: 14px;
      padding: 11px;
      cursor:pointer;
      transition: background .12s ease, transform .06s ease, border-color .12s ease;
    }
    .item:hover{ background: rgba(255,255,255,0.06); }
    .item:active{ transform: translateY(1px); }
    .item.active{
      border-color: rgba(124,92,255,0.65);
      background: rgba(124,92,255,0.10);
    }
    .itemTop{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .badge{
      font-family: var(--mono);
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      white-space:nowrap;
    }
    .itemTitle{
      font-size: 13px;
      margin:0;
      color: var(--text);
      letter-spacing:0.1px;
    }
    .itemSub{
      margin-top: 6px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
    }

    .now{
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .cover{
      width: 86px;
      height: 86px;
      border-radius: 16px;
      position: relative;
      overflow: hidden;
      background:
        radial-gradient(60px 60px at 30% 30%, rgba(124,92,255,0.55), transparent 60%),
        radial-gradient(70px 70px at 70% 60%, rgba(53,214,199,0.45), transparent 62%),
        rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      flex: 0 0 auto;
    }
    .cover img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    .cover.hasImage img{ display: block; }
    .now h2{
      margin:0;
      font-size: 16px;
      letter-spacing:0.2px;
    }
    .muted{ color: var(--muted); }
    .mono{ font-family: var(--mono); }

    .player{
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,0.03);
    }
    audio{ width: 100%; }

    .controls{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      padding: 3px 6px;
      border-radius: 8px;
    }

    .inspector{
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,0.03);
    }
    .inspectorHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .inspectGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 720px){
      .inspectGrid{ grid-template-columns: 1fr; }
    }
    .inspectItem{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height: 72px;
    }
    .inspectLabel{
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--muted2);
    }
    .inspectValue{
      font-size: 12px;
      color: var(--text);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .inspectActions{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .inspectHint{
      margin-top: 8px;
      font-size: 11px;
      color: var(--muted2);
    }

    .marketing{
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,0.02);
    }
    .marketingHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .marketingGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 720px){
      .marketingGrid{ grid-template-columns: 1fr; }
    }
    .marketingItem{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height: 72px;
    }
    .marketingLabel{
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--muted2);
    }
    .marketingValue{
      font-size: 12px;
      color: var(--text);
    }
    .marketingActions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .marketingPosts{
      margin-top: 10px;
      display:grid;
      gap:10px;
    }
    .postItem{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .postTitle{
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--muted2);
    }
    .postText{
      font-size: 13px;
      color: var(--text);
      white-space: pre-wrap;
    }

    .toast{
      position: fixed;
      left: 16px;
      bottom: 16px;
      max-width: 560px;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,0.84);
      color: rgba(255,255,255,0.92);
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: var(--shadow);
      display:none;
      z-index: 9999;
    }
    .toast.show{ display:block; }
    .toast .t1{ font-size: 12px; margin:0; }
    .toast .t2{ font-size: 12px; margin: 6px 0 0; color: rgba(255,255,255,0.70); }

    .hr{
      height:1px;
      background: var(--border);
      margin: 12px 0;
    }

    .foot{
      margin-top: 12px;
      color: var(--muted2);
      font-size: 12px;
    }
    .foot code{ font-family: var(--mono); }

    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
    }
    .toggle input{ transform: translateY(1px); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Music Generator Company</h1>
          <div class="sub">All playlists + all tracks • feed-driven web player</div>
        </div>
      </div>
      <div class="pillbar">
        <div class="pill">Feed: <code id="pillFeed">/releases/feed.json</code></div>
        <div class="pill">Mode: <code id="pillMode">auto</code></div>
        <div class="pill">Playlists: <code id="pillPl">0</code></div>
        <div class="pill">Tracks: <code id="pillTr">0</code></div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Playlists -->
      <div class="card">
        <div class="cardHead">
          <div>
            <p class="cardTitle">Playlists</p>
            <div class="cardMeta" id="plMeta">Loading feed…</div>
          </div>
          <div class="row" style="gap:8px;">
            <button class="btn small" id="btnReload" title="Reload feed + playlists">Reload</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="row" style="margin-bottom:10px;">
            <input class="input" id="plSearch" placeholder="Filter playlists (focus, sleep, workout)..." />
          </div>

          <div class="list" id="playlists"></div>

          <div class="hr"></div>

          <div class="row" style="gap:8px; flex-wrap:wrap;">
            <button class="btn small" id="btnCopyLink" title="Copy share link">Copy link</button>
            <button class="btn small" id="btnOpenBundle" title="Open selected playlist bundle">Open bundle</button>
            <div class="spacer"></div>
            <span class="kbd">J/K</span><span class="kbd">Space</span><span class="kbd">N/P</span>
          </div>

          <div class="foot">
            Works on VM (<code>/releases/feed.json</code>) and GitHub Pages (auto-detects repo base path).
          </div>
        </div>
      </div>

      <!-- RIGHT: Player + All tracks -->
      <div class="card">
        <div class="cardHead">
          <div>
            <p class="cardTitle">Now playing</p>
            <div class="cardMeta" id="nowMeta">Loading…</div>
          </div>
          <div class="row" style="gap:8px;">
            <button class="btn small" id="btnPrev" title="Previous track">Prev</button>
            <button class="btn small primary" id="btnPlay" title="Play/Pause">Play</button>
            <button class="btn small" id="btnNext" title="Next track">Next</button>
          </div>
        </div>

        <div class="cardBody">
          <div class="now">
            <div class="cover" id="cover"><img id="coverImg" alt="Cover art"></div>
            <div style="min-width:0;">
              <h2 id="trackTitle">—</h2>
              <div class="muted" id="trackSub" style="margin-top:6px;">—</div>
              <div class="muted mono" id="trackPath" style="margin-top:8px; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"></div>
            </div>
          </div>

          <div class="player">
            <audio id="audio" controls preload="metadata"></audio>
            <div class="controls">
              <button class="btn small" id="btnSeekBack" title="Back 10s">-10s</button>
              <button class="btn small" id="btnSeekFwd" title="Forward 10s">+10s</button>
              <div class="spacer"></div>

              <label class="toggle" title="Show only audio-looking files (.mp3/.wav/.ogg/.m4a)">
                <input type="checkbox" id="audioOnly" />
                Audio only
              </label>

              <span class="muted" style="font-size:12px;">Volume</span>
              <input id="vol" type="range" min="0" max="1" step="0.01" value="0.85" style="width:160px;">
            </div>
          </div>

          <div class="hr"></div>

          <div class="inspector" id="inspector">
            <div class="inspectorHead">
              <p class="cardTitle">Release Inspector</p>
              <div class="row" style="gap:8px;">
                <button class="btn small" id="btnCopyInspector" title="Copy all inspector fields">Copy all</button>
              </div>
            </div>

            <div class="inspectGrid">
              <div class="inspectItem">
                <div class="inspectLabel">Feed content_sha256</div>
                <div class="inspectValue mono" id="inspectFeedSha">—</div>
                <div class="inspectActions">
                  <button class="btn small" data-copy="feed_sha" data-label="Feed content_sha256">Copy</button>
                </div>
              </div>

              <div class="inspectItem">
                <div class="inspectLabel">Playlist context</div>
                <div class="inspectValue mono" id="inspectPlaylist">—</div>
                <div class="inspectActions">
                  <button class="btn small" data-copy="playlist_context" data-label="Playlist context">Copy</button>
                </div>
              </div>

              <div class="inspectItem">
                <div class="inspectLabel">Playlist sha256</div>
                <div class="inspectValue mono" id="inspectPlaylistSha">—</div>
                <div class="inspectActions">
                  <button class="btn small" data-copy="playlist_sha" data-label="Playlist sha256">Copy</button>
                </div>
              </div>

              <div class="inspectItem">
                <div class="inspectLabel">Web tree sha256</div>
                <div class="inspectValue mono" id="inspectWebTreeSha">—</div>
                <div class="inspectActions">
                  <button class="btn small" data-copy="web_tree_sha" data-label="Web tree sha256">Copy</button>
                </div>
              </div>

              <div class="inspectItem">
                <div class="inspectLabel">Manifest URL</div>
                <div class="inspectValue mono" id="inspectManifestUrl">—</div>
                <div class="inspectActions">
                  <button class="btn small" data-copy="manifest_url" data-label="Manifest URL">Copy</button>
                </div>
              </div>

              <div class="inspectItem">
                <div class="inspectLabel">Playlist URL</div>
                <div class="inspectValue mono" id="inspectPlaylistUrl">—</div>
                <div class="inspectActions">
                  <button class="btn small" data-copy="playlist_url" data-label="Playlist URL">Copy</button>
                </div>
              </div>

              <div class="inspectItem">
                <div class="inspectLabel">Track relpath</div>
                <div class="inspectValue mono" id="inspectTrackRel">—</div>
                <div class="inspectActions">
                  <button class="btn small" data-copy="track_relpath" data-label="Track relpath">Copy</button>
                </div>
              </div>

              <div class="inspectItem">
                <div class="inspectLabel">Track sha256</div>
                <div class="inspectValue mono" id="inspectTrackSha">—</div>
                <div class="inspectActions">
                  <button class="btn small" data-copy="track_sha" data-label="Track sha256">Copy</button>
                </div>
              </div>

              <div class="inspectItem">
                <div class="inspectLabel">Track bytes</div>
                <div class="inspectValue mono" id="inspectTrackBytes">—</div>
                <div class="inspectActions">
                  <button class="btn small" data-copy="track_bytes" data-label="Track bytes">Copy</button>
                </div>
              </div>

              <div class="inspectItem">
                <div class="inspectLabel">Marketing summary</div>
                <div class="inspectValue" id="inspectMarketingSummary">—</div>
                <div class="inspectActions">
                  <button class="btn small" data-copy="marketing_summary" data-label="Marketing summary">Copy</button>
                </div>
              </div>

              <div class="inspectItem">
                <div class="inspectLabel">Hashtags</div>
                <div class="inspectValue mono" id="inspectMarketingHashtags">—</div>
                <div class="inspectActions">
                  <button class="btn small" data-copy="marketing_hashtags" data-label="Hashtags">Copy</button>
                </div>
              </div>

              <div class="inspectItem">
                <div class="inspectLabel">Marketing cover URL</div>
                <div class="inspectValue mono" id="inspectMarketingCover">—</div>
                <div class="inspectActions">
                  <button class="btn small" data-copy="marketing_cover_url" data-label="Marketing cover URL">Copy</button>
                </div>
              </div>

              <div class="inspectItem">
                <div class="inspectLabel">Marketing media URL</div>
                <div class="inspectValue mono" id="inspectMarketingMedia">—</div>
                <div class="inspectActions">
                  <button class="btn small" data-copy="marketing_media_url" data-label="Marketing media URL">Copy</button>
                </div>
              </div>
            </div>

            <div class="inspectHint">Updates with the current track and selected playlist.</div>
          </div>

          <div class="marketing" id="marketing">
            <div class="marketingHead">
              <p class="cardTitle">Marketing Preview</p>
              <div class="row" style="gap:8px;">
                <button class="btn small" id="btnCopyMarketingAll" title="Copy summary + hashtags + posts">Copy all</button>
              </div>
            </div>

            <div class="marketingGrid">
              <div class="marketingItem">
                <div class="marketingLabel">Summary</div>
                <div class="marketingValue" id="mkSummary">—</div>
                <div class="marketingActions">
                  <button class="btn small" data-mkcopy="summary" data-mklabel="Summary">Copy</button>
                </div>
              </div>

              <div class="marketingItem">
                <div class="marketingLabel">Hashtags</div>
                <div class="marketingValue mono" id="mkHashtags">—</div>
                <div class="marketingActions">
                  <button class="btn small" data-mkcopy="hashtags" data-mklabel="Hashtags">Copy</button>
                </div>
              </div>

              <div class="marketingItem">
                <div class="marketingLabel">Teaser audio</div>
                <div class="marketingValue">
                  <audio id="mkTeaser" controls preload="metadata"></audio>
                  <div class="muted" id="mkTeaserEmpty">No teaser available.</div>
                </div>
                <div class="marketingActions">
                  <button class="btn small" data-mkcopy="teaser_url" data-mklabel="Teaser URL">Copy link</button>
                  <button class="btn small" id="mkTeaserOpen">Open</button>
                </div>
              </div>
            </div>

            <div class="marketingPosts" id="mkPosts"></div>
            <div class="muted" id="mkEmpty">No marketing preview available for this playlist.</div>
          </div>

          <div class="hr"></div>

          <div class="row" style="margin-bottom:10px;">
            <input class="input" id="trSearch" placeholder="Filter tracks (title, playlist, path)..." />
          </div>

          <div class="list" id="tracks"></div>

          <div class="foot" id="bundleFoot"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <p class="t1" id="toastT1"></p>
    <p class="t2" id="toastT2"></p>
  </div>

  <script src="bundle_data.js"></script>
  <script>
    "use strict";

    function $(id){ return document.getElementById(id); }

    function toast(t1, t2){
      const el = $("toast");
      $("toastT1").textContent = t1 || "";
      $("toastT2").textContent = t2 || "";
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => el.classList.remove("show"), 2600);
    }

    function copyText(text, label){
      const value = text ? String(text) : "";
      if (!value){
        toast("Nothing to copy", label ? (label + " is empty.") : "Value is empty.");
        return Promise.resolve(false);
      }
      return navigator.clipboard.writeText(value).then(
        () => { toast("Copied", label || value); return true; },
        () => { toast("Copy failed", "Your browser blocked clipboard access."); return false; }
      );
    }

    function fmtIso(iso){
      if (!iso) return "—";
      try{
        const d = new Date(iso);
        return d.toISOString().replace(".000Z","Z");
      }catch{
        return iso;
      }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c) => ({
        "&":"&amp;",
        "<":"&lt;",
        ">":"&gt;",
        "\"":"&quot;",
        "'":"&#039;",
      }[c]));
    }

    function basePrefix(){
      // Directory containing this index.html
      const p = window.location.pathname;
      if (p.endsWith("/index.html")) return p.slice(0, -"/index.html".length);
      if (p.endsWith("/")) return p.slice(0, -1);
      return p;
    }

    function urlJoin(prefix, path){
      // prefix like "" or "/music-generator-company"
      if (!prefix) return path.startsWith("/") ? path : ("/" + path);
      if (!path.startsWith("/")) path = "/" + path;
      return prefix + path;
    }

    function resolveFeedUrl(){
      const prefix = basePrefix();
      return urlJoin(prefix, "/releases/feed.json");
    }

    function feedUrlCandidates(){
      const primary = resolveFeedUrl();
      const root = "/releases/feed.json";
      if (primary === root) return [primary];
      return [primary, root];
    }

    async function fetchJson(url){
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
      return await r.json();
    }

    async function fetchText(url){
      try{
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) return null;
        return await r.text();
      }catch (e){
        return null;
      }
    }

    function isAudioPath(p){
      return typeof p === "string" && (p.endsWith(".mp3") || p.endsWith(".wav") || p.endsWith(".ogg") || p.endsWith(".m4a"));
    }

    function playlistTracks(playlist){
      if (!playlist) return [];
      if (Array.isArray(playlist)) return playlist;
      if (Array.isArray(playlist.tracks)) return playlist.tracks;
      if (Array.isArray(playlist.items)) return playlist.items;
      return [];
    }

    function trackDisplay(t, idx){
      const title =
        t.title ||
        t.name ||
        t.track_title ||
        (t.id ? `Track ${String(t.id).slice(0,8)}` : `Track ${idx+1}`);

      const path =
        t.web_path ||
        t.webPath ||
        t.dest ||
        t.path ||
        t.audio ||
        t.audio_path ||
        t.file ||
        "";

      return { title, path, raw: t };
    }

    function shortHash(s){
      if (!s) return "—";
      if (s.length <= 18) return s;
      return s.slice(0, 10) + "..." + s.slice(-6);
    }

    function stripOrigin(u){
      if (!u) return "";
      try{
        const origin = window.location.origin || "";
        if (origin && u.startsWith(origin)) return u.slice(origin.length) || "/";
      }catch{
        return u;
      }
      return u;
    }

    function absoluteUrl(u){
      if (!u) return "";
      try{
        return new URL(u, window.location.href).toString();
      }catch{
        return u;
      }
    }

    function normalizeRelpath(p){
      return String(p || "").replace(/^\.?\//, "");
    }

    function sanitizeRelpath(p){
      let out = normalizeRelpath(p);
      while (out.startsWith("../")){
        out = out.slice(3);
      }
      return out;
    }

    function marketingAssetUrl(bundleBase, rel){
      const cleaned = sanitizeRelpath(rel);
      if (!cleaned) return "";
      if (cleaned.startsWith("marketing/")){
        return withTrailingSlash(bundleBase) + cleaned;
      }
      return withTrailingSlash(bundleBase) + "marketing/" + cleaned;
    }

    function planHashtagsText(plan){
      if (!plan) return "";
      if (plan.hashtags_text) return String(plan.hashtags_text || "").trim();
      if (Array.isArray(plan.hashtags)){
        return plan.hashtags.map(t => "#" + String(t || "").trim()).join(" ").trim();
      }
      return "";
    }

    async function loadMarketingPreview(plan, bundleBase){
      if (!plan) return null;
      const paths = (plan && plan.paths) ? plan.paths : {};

      let summary = String(plan.summary || "").trim();
      const summaryRel = paths.summary || "";
      if (summaryRel){
        const text = await fetchText(marketingAssetUrl(bundleBase, summaryRel));
        if (text) summary = text.trim();
      }

      let hashtags = planHashtagsText(plan);
      const hashtagsRel = paths.hashtags || "";
      if (hashtagsRel){
        const text = await fetchText(marketingAssetUrl(bundleBase, hashtagsRel));
        if (text) hashtags = text.trim();
      }

      const teaserRel = paths.teaser || "";
      const teaserUrl = teaserRel ? marketingAssetUrl(bundleBase, teaserRel) : "";

      const postPaths = Array.isArray(paths.posts) ? paths.posts : [];
      const posts = [];
      if (postPaths.length){
        const items = await Promise.all(
          postPaths.map(async (rel, idx) => {
            const url = marketingAssetUrl(bundleBase, rel);
            const text = await fetchText(url);
            return {
              index: idx + 1,
              url,
              text: text ? text.trim() : "",
            };
          })
        );
        for (const it of items){
          posts.push(it);
        }
      }

      const out = {
        summary,
        hashtags,
        teaser_url: teaserUrl,
        posts,
      };

      if (!summary && !hashtags && !teaserUrl && !posts.length) return null;
      return out;
    }

    function marketingMetaFromPlan(plan, bundleBase){
      if (!plan || typeof plan !== "object") return null;
      const paths = (plan && typeof plan.paths === "object") ? plan.paths : {};
      const coverObj = (plan.cover && typeof plan.cover === "object") ? plan.cover : {};
      const mediaObj = (plan.media && typeof plan.media === "object") ? plan.media : {};

      let summary = String(plan.summary || "").trim();
      let hashtagsText = "";
      if (plan.hashtags_text) hashtagsText = String(plan.hashtags_text || "").trim();
      else if (Array.isArray(plan.hashtags)){
        hashtagsText = plan.hashtags.map(t => "#" + String(t || "").trim()).join(" ").trim();
      }

      let coverUrl = "";
      if (plan.cover_url) coverUrl = String(plan.cover_url || "").trim();
      let coverRel = "";
      if (!coverUrl){
        coverRel = String(coverObj.dst || coverObj.path || "").trim();
        if (!coverRel && paths.cover) coverRel = String(paths.cover || "").trim();
        if (coverRel) coverUrl = marketingAssetUrl(bundleBase, coverRel);
      }

      let mediaUrl = "";
      if (mediaObj.video_url || mediaObj.media_url){
        mediaUrl = String(mediaObj.video_url || mediaObj.media_url || "").trim();
      }
      let mediaRel = "";
      if (!mediaUrl){
        mediaRel = String(mediaObj.video_path || mediaObj.media_path || "").trim();
        if (!mediaRel && paths.media) mediaRel = String(paths.media || "").trim();
        if (mediaRel) mediaUrl = marketingAssetUrl(bundleBase, mediaRel);
      }

      if (!summary && !hashtagsText && !coverUrl && !mediaUrl) return null;
      return {
        summary,
        hashtags_text: hashtagsText,
        cover_url: coverUrl,
        media_url: mediaUrl,
      };
    }

    function embeddedBundle(){
      const b = window.__MGC_BUNDLE__;
      if (!b || typeof b !== "object") return null;
      return b;
    }

    function findManifestTrack(manifest, track){
      if (!manifest || !track) return null;
      const tracks = Array.isArray(manifest.tracks) ? manifest.tracks : [];
      if (!tracks.length) return null;

      const raw = track.raw || {};
      const ids = [raw.track_id, raw.trackId, raw.id, track.track_id, track.id].filter(Boolean);
      for (const id of ids){
        const hit = tracks.find(t => t && t.track_id === id);
        if (hit) return hit;
      }

      const path = track.path || "";
      if (path){
        const n = normalizeRelpath(path);
        const hit = tracks.find(t => t && normalizeRelpath(t.relpath || "") === n);
        if (hit) return hit;
      }

      const src = track.src || "";
      if (src){
        const hit = tracks.find(t => t && typeof t.relpath === "string" && src.endsWith(t.relpath));
        if (hit) return hit;
      }

      const title = track.title || "";
      if (title){
        const hit = tracks.find(t => t && t.title === title);
        if (hit) return hit;
      }

      if (Number.isFinite(track.playlist_idx)){
        const hit = tracks.find(t => t && t.index === track.playlist_idx);
        if (hit) return hit;
      }

      return null;
    }

    function normalizeBundleBase(ctx){
      const prefix = basePrefix();
      const u = (ctx && ctx.url) ? ctx.url : "";
      return urlJoin(prefix, u);
    }

    function withTrailingSlash(u){
      return u.endsWith("/") ? u : (u + "/");
    }

    function computeTrackSrc(bundleBase, path){
      if (!path) return "";
      if (path.startsWith("http://") || path.startsWith("https://")) return path;
      if (path.startsWith("/")) return urlJoin(basePrefix(), path);
      return withTrailingSlash(bundleBase) + path.replace(/^\.?\//, "");
    }

    async function loadBundle(ctx){
      const bundleBase = withTrailingSlash(normalizeBundleBase(ctx));
      const playlistUrl = bundleBase + "playlist.json";
      const manifestUrl = bundleBase + "web_manifest.json";
      const marketingUrl = bundleBase + "marketing/marketing_plan.json";

      const embedded = embeddedBundle();
      if (embedded && (!ctx || !ctx.url)){
        const preview = embedded.marketing_preview || null;
        let teaserUrl = preview && preview.teaser_path ? marketingAssetUrl(bundleBase, preview.teaser_path) : "";
        let posts = [];
        if (preview && Array.isArray(preview.posts)){
          posts = preview.posts.map((p, i) => ({
            index: p.index || (i + 1),
            url: "",
            text: (p && p.text) ? String(p.text).trim() : "",
          }));
        }
        const marketingPreview = preview ? {
          summary: preview.summary || "",
          hashtags: preview.hashtags || "",
          teaser_url: teaserUrl,
          posts,
        } : null;

        return {
          bundleBase,
          playlistUrl,
          manifestUrl,
          playlist: embedded.playlist || null,
          manifest: embedded.manifest || null,
          marketingPlan: embedded.marketing_plan || null,
          marketingPreview,
        };
      }

      const [playlist, manifest, marketingPlan] = await Promise.all([
        fetchJson(playlistUrl),
        fetchJson(manifestUrl).catch(() => null),
        fetchJson(marketingUrl).catch(() => null),
      ]);

      let marketingPreview = null;
      try{
        marketingPreview = await loadMarketingPreview(marketingPlan, bundleBase);
      }catch (e){
        marketingPreview = null;
      }

      return { bundleBase, playlistUrl, manifestUrl, playlist, manifest, marketingPlan, marketingPreview };
    }

    function setModeLabel(){
      const p = basePrefix();
      $("pillMode").textContent = p ? "pages" : "vm";
    }

    function setCounts(state){
      $("pillPl").textContent = String(state.playlists.length);
      $("pillTr").textContent = String(state.allTracks.length);
    }

    function currentShareUrl(state){
      const u = new URL(window.location.href);
      if (state && state.selected && state.selected.context){
        u.searchParams.set("playlist", state.selected.context);
      }else{
        u.searchParams.delete("playlist");
      }
      return u.toString();
    }

    function setActivePlaylistItem(name){
      const items = $("playlists").querySelectorAll(".item");
      for (const it of items){
        it.classList.toggle("active", it.dataset.context === name);
      }
    }

    function renderPlaylists(state){
      const list = $("playlists");
      list.innerHTML = "";

      const q = $("plSearch").value.trim().toLowerCase();
      const shown = q
        ? state.playlists.filter(p => (p.context || "").toLowerCase().includes(q))
        : state.playlists;

      // Always show an "All" pseudo-playlist
      const allDiv = document.createElement("div");
      allDiv.className = "item";
      allDiv.dataset.context = "__all__";
      if (!state.selected) allDiv.classList.add("active");
      allDiv.innerHTML = `
        <div class="itemTop">
          <span class="badge">all</span>
          <h3 class="itemTitle">All playlists</h3>
          <span class="spacer"></span>
          <span class="badge">${state.allTracks.length} tracks</span>
        </div>
        <div class="itemSub">
          <span class="mono">Includes every loaded playlist + track</span>
        </div>
      `;
      list.appendChild(allDiv);

      if (!shown.length){
        const div = document.createElement("div");
        div.className = "muted";
        div.style.padding = "6px 2px";
        div.textContent = "No playlists found.";
        list.appendChild(div);
        return;
      }

      for (const p of shown){
        const div = document.createElement("div");
        div.className = "item";
        div.dataset.context = p.context;

        const mtime = fmtIso(p.mtime);
        const tracks = p.tracks ? p.tracks.length : 0;
        const url = p.url || "";

        if (state.selected && state.selected.context === p.context) div.classList.add("active");

        div.innerHTML = `
          <div class="itemTop">
            <span class="badge">playlist</span>
            <h3 class="itemTitle">${escapeHtml(p.context)}</h3>
            <span class="spacer"></span>
            <span class="badge">${tracks} tracks</span>
          </div>
          <div class="itemSub">
            <span>mtime: <span class="mono">${escapeHtml(mtime)}</span></span>
            <span>url: <span class="mono">${escapeHtml(url)}</span></span>
          </div>
        `;
        list.appendChild(div);
      }
    }

    function filteredTracks(state){
      const q = $("trSearch").value.trim().toLowerCase();
      const audioOnly = $("audioOnly").checked;

      let base = state.allTracks;
      if (state.selected){
        base = base.filter(t => t.playlist_context === state.selected.context);
      }

      if (audioOnly){
        base = base.filter(t => isAudioPath(t.path || ""));
      }

      if (!q) return base;

      return base.filter(t => {
        const hay = [
          t.title || "",
          t.playlist_context || "",
          t.path || "",
          t.src || "",
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    function renderTracks(state){
      const list = $("tracks");
      list.innerHTML = "";

      const shown = filteredTracks(state);

      if (!shown.length){
        const div = document.createElement("div");
        div.className = "muted";
        div.textContent = "No tracks match your filters.";
        list.appendChild(div);
        return;
      }

      for (let i = 0; i < shown.length; i++){
        const t = shown[i];
        const div = document.createElement("div");
        div.className = "item";
        div.dataset.gidx = String(t.global_idx);

        const active = (state.current && state.current.global_idx === t.global_idx);
        if (active) div.classList.add("active");

        const badge = isAudioPath(t.path || "") ? "audio" : "file";
        div.innerHTML = `
          <div class="itemTop">
            <span class="badge">${badge}</span>
            <h3 class="itemTitle">${escapeHtml(t.title || "—")}</h3>
            <span class="spacer"></span>
            <span class="badge">${escapeHtml(t.playlist_context || "—")}</span>
          </div>
          <div class="itemSub">
            <span class="mono" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 100%;">${escapeHtml(t.path || "—")}</span>
          </div>
        `;
        list.appendChild(div);
      }
    }

    function setInspectorValue(id, value, opts){
      const el = $(id);
      if (!el) return;
      const has = value !== undefined && value !== null && String(value).length;
      if (!has){
        el.textContent = "—";
        el.title = "";
        return;
      }

      const raw = String(value);
      let display = raw;
      if (opts && opts.shortHash) display = shortHash(raw);
      if (opts && opts.shortUrl) display = stripOrigin(raw);
      if (opts && opts.bytes) display = raw + " bytes";
      el.textContent = display;
      el.title = (display !== raw) ? raw : "";
    }

    function setCoverImage(url){
      const cover = $("cover");
      const img = $("coverImg");
      if (!cover || !img) return;
      if (url){
        cover.classList.add("hasImage");
        img.src = url;
      }else{
        cover.classList.remove("hasImage");
        img.removeAttribute("src");
      }
    }

    function setMarketingValue(id, value){
      const el = $(id);
      if (!el) return;
      const has = value !== undefined && value !== null && String(value).length;
      el.textContent = has ? String(value) : "—";
    }

    function marketingSummaryText(mk){
      if (!mk) return "";
      const lines = [];
      if (mk.summary) lines.push("Summary: " + mk.summary);
      if (mk.hashtags) lines.push("Hashtags: " + mk.hashtags);
      if (mk.teaser_url) lines.push("Teaser: " + mk.teaser_url);
      if (mk.posts && mk.posts.length){
        lines.push("Posts:");
        mk.posts.forEach((p, i) => {
          const txt = p && p.text ? String(p.text).trim() : "";
          if (txt) lines.push((i + 1) + ". " + txt);
        });
      }
      return lines.join("\n");
    }

    function setMarketingPreview(state){
      const pl = state.selected ? state.selected : (state.current ? findPlaylistByName(state, state.current.playlist_context) : null);
      const mk = pl && pl.marketing ? pl.marketing : null;
      state.marketingPreview = mk;

      const empty = $("mkEmpty");
      const postsEl = $("mkPosts");
      const teaser = $("mkTeaser");
      const teaserEmpty = $("mkTeaserEmpty");
      const teaserOpen = $("mkTeaserOpen");

      if (!mk){
        setMarketingValue("mkSummary", "");
        setMarketingValue("mkHashtags", "");
        if (postsEl) postsEl.innerHTML = "";
        if (teaser){
          teaser.removeAttribute("src");
          teaser.load();
          teaser.style.display = "none";
        }
        if (teaserEmpty) teaserEmpty.style.display = "";
        if (teaserOpen) teaserOpen.setAttribute("disabled", "disabled");
        if (empty) empty.style.display = "";
        return;
      }

      if (empty) empty.style.display = "none";
      setMarketingValue("mkSummary", mk.summary || "");
      setMarketingValue("mkHashtags", mk.hashtags || "");

      if (teaser){
        if (mk.teaser_url){
          teaser.src = mk.teaser_url;
          teaser.style.display = "";
          if (teaserEmpty) teaserEmpty.style.display = "none";
          if (teaserOpen) teaserOpen.removeAttribute("disabled");
        }else{
          teaser.removeAttribute("src");
          teaser.load();
          teaser.style.display = "none";
          if (teaserEmpty) teaserEmpty.style.display = "";
          if (teaserOpen) teaserOpen.setAttribute("disabled", "disabled");
        }
      }

      if (postsEl){
        postsEl.innerHTML = "";
        if (mk.posts && mk.posts.length){
          mk.posts.forEach((p, i) => {
            const text = p && p.text ? String(p.text).trim() : "";
            const div = document.createElement("div");
            div.className = "postItem";
            div.innerHTML = `
              <div class="postTitle">Post ${i + 1}</div>
              <div class="postText">${escapeHtml(text || "(missing)")}</div>
              <div class="marketingActions">
                <button class="btn small" data-mkpost="${i}">Copy</button>
              </div>
            `;
            postsEl.appendChild(div);
          });
        }else{
          const div = document.createElement("div");
          div.className = "muted";
          div.textContent = "No posts available.";
          postsEl.appendChild(div);
        }
      }
    }

    function setInspector(state){
      const cur = state.current || null;
      const pl = cur ? findPlaylistByName(state, cur.playlist_context) : state.selected;
      const manifest = pl && pl.manifest ? pl.manifest : null;
      const mTrack = findManifestTrack(manifest, cur);
      const marketing = manifest && manifest.marketing ? manifest.marketing : null;
      const plan = pl && pl.marketingPlan ? pl.marketingPlan : null;
      const planMeta = marketingMetaFromPlan(plan, pl ? pl.bundleBase : "");
      let summaryText = "";
      if (marketing && marketing.summary) summaryText = String(marketing.summary || "").trim();
      if (!summaryText && planMeta && planMeta.summary) summaryText = planMeta.summary;
      let hashtagsText = "";
      if (marketing){
        if (marketing.hashtags_text) hashtagsText = String(marketing.hashtags_text || "").trim();
        else if (Array.isArray(marketing.hashtags)){
          hashtagsText = marketing.hashtags.map(t => "#" + String(t || "").trim()).join(" ").trim();
        }
      }
      if (!hashtagsText && planMeta && planMeta.hashtags_text) hashtagsText = planMeta.hashtags_text;
      let marketingMediaUrl = "";
      if (marketing){
        if (marketing.media_url){
          marketingMediaUrl = String(marketing.media_url || "").trim();
        }else if (marketing.marketing_media_path){
          marketingMediaUrl = computeTrackSrc(pl ? pl.bundleBase : "", String(marketing.marketing_media_path || "").trim());
        }else if (marketing.media_path){
          marketingMediaUrl = computeTrackSrc(pl ? pl.bundleBase : "", "marketing/" + String(marketing.media_path || "").replace(/^\/+/, ""));
        }
      }
      if (!marketingMediaUrl && planMeta && planMeta.media_url) marketingMediaUrl = planMeta.media_url;
      let marketingCoverUrl = "";
      if (marketing){
        if (marketing.cover_url){
          marketingCoverUrl = String(marketing.cover_url || "").trim();
        }else if (marketing.marketing_cover_path){
          marketingCoverUrl = computeTrackSrc(pl ? pl.bundleBase : "", String(marketing.marketing_cover_path || "").trim());
        }else if (marketing.cover_path){
          marketingCoverUrl = computeTrackSrc(pl ? pl.bundleBase : "", "marketing/" + String(marketing.cover_path || "").replace(/^\/+/, ""));
        }
      }
      if (!marketingCoverUrl && planMeta && planMeta.cover_url) marketingCoverUrl = planMeta.cover_url;

      const values = {
        feed_sha: state.feed && state.feed.content_sha256 ? state.feed.content_sha256 : "",
        playlist_context: pl && pl.context ? pl.context : "",
        playlist_sha: manifest && manifest.playlist_sha256 ? manifest.playlist_sha256 : "",
        web_tree_sha: manifest && manifest.web_tree_sha256 ? manifest.web_tree_sha256 : "",
        manifest_url: pl && pl.manifestUrl ? absoluteUrl(pl.manifestUrl) : "",
        playlist_url: pl && pl.playlistUrl ? absoluteUrl(pl.playlistUrl) : "",
        track_relpath: (mTrack && mTrack.relpath) || (cur && cur.path) || "",
        track_sha: (mTrack && mTrack.sha256) || "",
        track_bytes: (mTrack && mTrack.bytes != null) ? String(mTrack.bytes) : "",
        marketing_summary: summaryText,
        marketing_hashtags: hashtagsText,
        marketing_media_url: marketingMediaUrl,
        marketing_cover_url: marketingCoverUrl,
      };

      state.inspector = values;

      setInspectorValue("inspectFeedSha", values.feed_sha, { shortHash: true });
      setInspectorValue("inspectPlaylist", values.playlist_context, {});
      setInspectorValue("inspectPlaylistSha", values.playlist_sha, { shortHash: true });
      setInspectorValue("inspectWebTreeSha", values.web_tree_sha, { shortHash: true });
      setInspectorValue("inspectManifestUrl", values.manifest_url, { shortUrl: true });
      setInspectorValue("inspectPlaylistUrl", values.playlist_url, { shortUrl: true });
      setInspectorValue("inspectTrackRel", values.track_relpath, {});
      setInspectorValue("inspectTrackSha", values.track_sha, { shortHash: true });
      setInspectorValue("inspectTrackBytes", values.track_bytes, { bytes: true });
      setInspectorValue("inspectMarketingSummary", values.marketing_summary, {});
      setInspectorValue("inspectMarketingHashtags", values.marketing_hashtags, {});
      setInspectorValue("inspectMarketingCover", values.marketing_cover_url, { shortUrl: true });
      setInspectorValue("inspectMarketingMedia", values.marketing_media_url, { shortUrl: true });
      setCoverImage(values.marketing_cover_url);
    }

    function inspectorSummary(state){
      const v = state.inspector || {};
      const pairs = [
        ["feed_content_sha256", v.feed_sha],
        ["playlist_context", v.playlist_context],
        ["playlist_sha256", v.playlist_sha],
        ["web_tree_sha256", v.web_tree_sha],
        ["manifest_url", v.manifest_url],
        ["playlist_url", v.playlist_url],
        ["track_relpath", v.track_relpath],
        ["track_sha256", v.track_sha],
        ["track_bytes", v.track_bytes],
        ["marketing_summary", v.marketing_summary],
        ["marketing_hashtags", v.marketing_hashtags],
        ["marketing_cover_url", v.marketing_cover_url],
        ["marketing_media_url", v.marketing_media_url],
      ];
      return pairs.map((p) => p[0] + ": " + (p[1] || "—")).join("\n");
    }

    function setNowPlaying(state){
      const t = state.current || null;
      if (!t){
        $("trackTitle").textContent = "—";
        $("trackSub").textContent = "—";
        $("trackPath").textContent = "";
        $("nowMeta").textContent = "Pick a track from the list.";
        $("bundleFoot").textContent = "";
        setInspector(state);
        return;
      }

      $("trackTitle").textContent = t.title || "—";
      $("trackSub").textContent = `playlist: ${t.playlist_context || "—"}`;
      $("trackPath").textContent = t.src || "";

      const gen = state.feed && state.feed.generated_at ? fmtIso(state.feed.generated_at) : "—";
      const sha = state.feed && state.feed.content_sha256 ? state.feed.content_sha256.slice(0, 16) + "…" : "—";
      $("nowMeta").textContent = `feed generated_at: ${gen} • content_sha256: ${sha}`;

      const footBits = [];
      if (t.bundleBase) footBits.push(`bundle: ${t.bundleBase}`);
      if (t.playlistUrl) footBits.push(`playlist: ${t.playlistUrl}`);
      if (t.manifestUrl) footBits.push(`manifest: ${t.manifestUrl}`);
      $("bundleFoot").textContent = footBits.join(" • ");
      setInspector(state);
      setMarketingPreview(state);
    }

    function setAudioSource(state){
      const a = $("audio");
      const t = state.current || null;
      if (!t || !t.src){
        a.removeAttribute("src");
        a.load();
        $("btnPlay").textContent = "Play";
        return;
      }
      a.src = t.src;
      a.load();
      $("btnPlay").textContent = "Play";
    }

    function playPause(){
      const a = $("audio");
      if (!a.src){
        toast("No track loaded", "Pick a track first.");
        return;
      }
      if (a.paused){
        a.play().catch(() => {});
        $("btnPlay").textContent = "Pause";
      }else{
        a.pause();
        $("btnPlay").textContent = "Play";
      }
    }

    function seekBy(seconds){
      const a = $("audio");
      if (!isFinite(a.duration)) return;
      a.currentTime = Math.max(0, Math.min(a.duration, a.currentTime + seconds));
    }

    function pickPlayable(tracks){
      const idx = tracks.findIndex(t => isAudioPath(t.path || "") && t.src);
      return idx >= 0 ? tracks[idx] : (tracks[0] || null);
    }

    function nextPrev(state, delta){
      const shown = filteredTracks(state);
      if (!shown.length) return;

      const cur = state.current ? shown.findIndex(x => x.global_idx === state.current.global_idx) : -1;
      const j = (cur < 0) ? 0 : (cur + delta + shown.length) % shown.length;

      state.current = shown[j];
      setNowPlaying(state);
      setAudioSource(state);

      renderTracks(state);

      const a = $("audio");
      if (!a.paused){
        a.play().catch(() => {});
        $("btnPlay").textContent = "Pause";
      }
    }

    async function loadAllPlaylists(state){
      const feedUrls = feedUrlCandidates();
      let feed = null;
      let feedUrl = "";
      for (const cand of feedUrls){
        try{
          feed = await fetchJson(cand);
          feedUrl = cand;
          break;
        }catch (e){
          // try next candidate
        }
      }

      const out = [];
      let failed = 0;

      if (feed){
        $("pillFeed").textContent = stripOrigin(feedUrl);
        state.feed = feed;

        const ctxs = (feed && feed.latest && Array.isArray(feed.latest.contexts)) ? feed.latest.contexts : [];
        const webCtxs = ctxs.filter(x => x.kind === "web");

        $("plMeta").textContent = webCtxs.length ? `Found ${webCtxs.length} playlists. Loading bundles…` : "No web playlists found in feed.";

        // Load each bundle with a small concurrency limit to avoid a burst
        const limit = 4;
        const q = webCtxs.slice();

        async function worker(){
          while (q.length){
            const ctx = q.shift();
            try{
              const bundle = await loadBundle(ctx);
              const rawTracks = playlistTracks(bundle.playlist).map((t, i) => {
                const d = trackDisplay(t, i);
                return {
                  title: d.title,
                  path: d.path,
                  raw: d.raw,
                  src: computeTrackSrc(bundle.bundleBase, d.path),
                };
              });

              out.push({
                context: ctx.context,
                mtime: ctx.mtime,
                url: ctx.url,
                track_count: ctx.track_count,
                bundleBase: bundle.bundleBase,
                playlistUrl: bundle.playlistUrl,
                manifestUrl: bundle.manifestUrl,
                manifest: bundle.manifest,
                marketingPlan: bundle.marketingPlan || null,
                marketing: bundle.marketingPreview || null,
                tracks: rawTracks,
              });
            }catch (e){
              failed++;
              console.error("Failed to load playlist:", ctx && ctx.context, e);
            }
          }
        }

        const workers = [];
        for (let i = 0; i < Math.min(limit, webCtxs.length); i++){
          workers.push(worker());
        }
        await Promise.all(workers);

        const msg = failed ? `Loaded ${out.length}/${webCtxs.length} playlists (${failed} failed).` : `Loaded ${out.length} playlists.`;
        $("plMeta").textContent = msg;
      }else{
        $("pillFeed").textContent = "local";
        $("plMeta").textContent = "Feed not available. Loading local bundle…";
        state.feed = null;

        const ctx = { context: "local", url: "" };
        const bundle = await loadBundle(ctx);
        const playlist = bundle.playlist || {};
        const ctxName = playlist.context || playlist.name || "local";
        const rawTracks = playlistTracks(bundle.playlist).map((t, i) => {
          const d = trackDisplay(t, i);
          return {
            title: d.title,
            path: d.path,
            raw: d.raw,
            src: computeTrackSrc(bundle.bundleBase, d.path),
          };
        });

        out.push({
          context: ctxName,
          mtime: (bundle.manifest && bundle.manifest.generated_at) ? bundle.manifest.generated_at : "",
          url: "",
          track_count: rawTracks.length,
          bundleBase: bundle.bundleBase,
          playlistUrl: bundle.playlistUrl,
          manifestUrl: bundle.manifestUrl,
          manifest: bundle.manifest,
          marketingPlan: bundle.marketingPlan || null,
          marketing: bundle.marketingPreview || null,
          tracks: rawTracks,
        });
        $("plMeta").textContent = `Loaded local bundle (${ctxName}).`;
        toast("Local bundle", "Feed not available; loaded playlist.json in this bundle.");
      }

      // Sort playlists (context name)
      out.sort((a,b) => String(a.context).localeCompare(String(b.context)));

      state.playlists = out;

      // Flatten tracks
      const all = [];
      let g = 0;
      for (const p of out){
        for (let i = 0; i < (p.tracks || []).length; i++){
          const t = p.tracks[i];
          all.push({
            global_idx: g++,
            playlist_context: p.context,
            playlist_idx: i,
            title: t.title,
            path: t.path,
            src: t.src,
            bundleBase: p.bundleBase,
            playlistUrl: p.playlistUrl,
            manifestUrl: p.manifestUrl,
          });
        }
      }
      state.allTracks = all;

      setCounts(state);

      if (!state.current){
        const pick = pickPlayable(state.allTracks);
        state.current = pick;
        setNowPlaying(state);
        setAudioSource(state);
      }
    }

    function findPlaylistByName(state, name){
      return state.playlists.find(p => p.context === name) || null;
    }

    function setSelectedPlaylist(state, pl){
      state.selected = pl;
      renderPlaylists(state);
      renderTracks(state);

      if (pl){
        toast("Playlist selected", pl.context);
      }else{
        toast("Playlist selected", "All playlists");
      }

      // If current track isn't in the selected playlist anymore, pick the first playable in view
      const shown = filteredTracks(state);
      if (!shown.length){
        state.current = null;
        setNowPlaying(state);
        setAudioSource(state);
        return;
      }
      if (!state.current || !shown.some(x => state.current && x.global_idx === state.current.global_idx)){
        state.current = pickPlayable(shown);
        setNowPlaying(state);
        setAudioSource(state);
      }else{
        setMarketingPreview(state);
      }
    }

    function movePlaylistSelection(state, delta){
      if (!state.playlists.length) return;

      // When "All" is selected, treat it as index -1; J selects first playlist
      const curName = state.selected ? state.selected.context : null;
      const i = curName ? state.playlists.findIndex(p => p.context === curName) : -1;
      const j = Math.max(-1, Math.min(state.playlists.length - 1, i + delta));

      if (j < 0) setSelectedPlaylist(state, null);
      else setSelectedPlaylist(state, state.playlists[j]);
    }

    async function main(){
      const state = {
        feed: null,
        playlists: [],
        allTracks: [],
        selected: null, // null = All
        current: null,
        inspector: {},
        marketingPreview: null,
      };

      setModeLabel();

      try{
        await loadAllPlaylists(state);
        renderPlaylists(state);
        renderTracks(state);

        // Support ?playlist=focus
        const u = new URL(window.location.href);
        const want = u.searchParams.get("playlist");
        if (want){
          const pl = findPlaylistByName(state, want);
          if (pl) setSelectedPlaylist(state, pl);
        }

        toast("Ready", "Loaded playlists and tracks.");
      }catch (e){
        console.error(e);
        $("plMeta").textContent = "Failed to load feed/playlists.";
        toast("Load failed", String(e && e.message ? e.message : e));
      }

      $("btnReload").addEventListener("click", async () => {
        try{
          $("plMeta").textContent = "Reloading…";
          state.feed = null;
          state.playlists = [];
          state.allTracks = [];
          state.selected = null;
          state.current = null;
          await loadAllPlaylists(state);
          renderPlaylists(state);
          renderTracks(state);
          toast("Reloaded", "Loaded latest playlists and tracks.");
        }catch (e){
          toast("Reload failed", String(e && e.message ? e.message : e));
        }
      });

      $("plSearch").addEventListener("input", () => renderPlaylists(state));
      $("trSearch").addEventListener("input", () => renderTracks(state));
      $("audioOnly").addEventListener("change", () => {
        renderTracks(state);
        // keep current sane
        const shown = filteredTracks(state);
        if (state.current && !shown.some(x => x.global_idx === state.current.global_idx)){
          state.current = pickPlayable(shown);
          setNowPlaying(state);
          setAudioSource(state);
        }
      });

      $("playlists").addEventListener("click", (ev) => {
        const item = ev.target.closest(".item");
        if (!item) return;
        const name = item.dataset.context;

        if (name === "__all__"){
          setSelectedPlaylist(state, null);
          return;
        }
        const pl = findPlaylistByName(state, name);
        if (pl) setSelectedPlaylist(state, pl);
      });

      $("tracks").addEventListener("click", (ev) => {
        const item = ev.target.closest(".item");
        if (!item) return;
        const gidx = parseInt(item.dataset.gidx || "-1", 10);
        if (!Number.isFinite(gidx) || gidx < 0) return;

        const t = state.allTracks.find(x => x.global_idx === gidx);
        if (!t) return;

        state.current = t;
        setNowPlaying(state);
        setAudioSource(state);
        renderTracks(state);
      });

      $("btnPlay").addEventListener("click", () => playPause());
      $("btnPrev").addEventListener("click", () => nextPrev(state, -1));
      $("btnNext").addEventListener("click", () => nextPrev(state, +1));
      $("btnSeekBack").addEventListener("click", () => seekBy(-10));
      $("btnSeekFwd").addEventListener("click", () => seekBy(+10));

      $("vol").addEventListener("input", (ev) => {
        const v = parseFloat(ev.target.value);
        $("audio").volume = Math.max(0, Math.min(1, v));
      });
      $("audio").volume = parseFloat($("vol").value);

      $("audio").addEventListener("play", () => { $("btnPlay").textContent = "Pause"; });
      $("audio").addEventListener("pause", () => { $("btnPlay").textContent = "Play"; });
      $("audio").addEventListener("ended", () => { nextPrev(state, +1); });

      $("btnCopyLink").addEventListener("click", () => {
        const u = currentShareUrl(state);
        copyText(u, "Share link");
      });

      $("btnCopyInspector").addEventListener("click", () => {
        copyText(inspectorSummary(state), "Inspector summary");
      });

      $("inspector").addEventListener("click", (ev) => {
        const btn = ev.target.closest("button[data-copy]");
        if (!btn) return;
        const key = btn.dataset.copy || "";
        const label = btn.dataset.label || key;
        const val = state.inspector && state.inspector[key] ? state.inspector[key] : "";
        copyText(val, label);
      });

      $("btnCopyMarketingAll").addEventListener("click", () => {
        const mk = state.marketingPreview;
        copyText(marketingSummaryText(mk), "Marketing preview");
      });

      $("marketing").addEventListener("click", (ev) => {
        const btn = ev.target.closest("button");
        if (!btn) return;
        const mk = state.marketingPreview;
        if (!mk) return;

        const mkcopy = btn.dataset.mkcopy || "";
        if (mkcopy){
          let val = "";
          if (mkcopy === "summary") val = mk.summary || "";
          if (mkcopy === "hashtags") val = mk.hashtags || "";
          if (mkcopy === "teaser_url") val = mk.teaser_url || "";
          const label = btn.dataset.mklabel || mkcopy;
          copyText(val, label);
          return;
        }

        const mkpost = btn.dataset.mkpost || "";
        if (mkpost){
          const idx = parseInt(mkpost, 10);
          if (Number.isFinite(idx) && mk.posts && mk.posts[idx]){
            const txt = mk.posts[idx].text || "";
            copyText(txt, `Post ${idx + 1}`);
          }
        }
      });

      $("mkTeaserOpen").addEventListener("click", () => {
        const mk = state.marketingPreview;
        if (mk && mk.teaser_url){
          window.open(mk.teaser_url, "_blank", "noopener");
        }
      });

      $("btnOpenBundle").addEventListener("click", () => {
        const pl = state.selected;
        if (!pl){
          toast("No bundle", "Select a playlist first.");
          return;
        }
        const u = normalizeBundleBase({ url: pl.url });
        window.open(u, "_blank", "noopener");
      });

      // Keyboard shortcuts:
      // J/K = move playlist selection (includes "All")
      // Space = play/pause
      // N/P = next/prev track (in the currently filtered track list)
      // Left/Right = seek
      window.addEventListener("keydown", (ev) => {
        const tag = (ev.target && ev.target.tagName) ? ev.target.tagName.toLowerCase() : "";
        const inInput = tag === "input" || tag === "textarea";
        if (inInput) return;

        if (ev.key === " "){
          ev.preventDefault();
          playPause();
          return;
        }
        if (ev.key === "j" || ev.key === "J"){ movePlaylistSelection(state, +1); return; }
        if (ev.key === "k" || ev.key === "K"){ movePlaylistSelection(state, -1); return; }
        if (ev.key === "n" || ev.key === "N"){ nextPrev(state, +1); return; }
        if (ev.key === "p" || ev.key === "P"){ nextPrev(state, -1); return; }
        if (ev.key === "ArrowLeft"){ seekBy(-5); return; }
        if (ev.key === "ArrowRight"){ seekBy(+5); return; }
      });
    }

    main();
  </script>
</body>
</html>

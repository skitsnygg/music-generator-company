<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MGC Player</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    .wrap { max-width: 980px; margin: 0 auto; }
    h1 { margin: 0 0 8px 0; }
    .meta { color: #444; margin-bottom: 18px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px 14px; margin: 12px 0; }
    .row { display: flex; justify-content: space-between; gap: 12px; align-items: baseline; flex-wrap: wrap; }
    .title { font-weight: 700; }
    .small { color: #555; font-size: 0.95rem; }
    .warn { color: #7a4a00; }
    .bad { color: #7a0000; }
    audio { width: 100%; margin-top: 8px; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
    a { color: inherit; }
    .btn {
      display: inline-block;
      border: 1px solid #ddd;
      padding: 6px 10px;
      border-radius: 8px;
      background: #fafafa;
      cursor: pointer;
      text-decoration: none;
    }
    .btn:hover { background: #f2f2f2; }
    .stack { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>MGC Player</h1>

    <div class="meta">
      Status: <span id="status"><code>loading</code></span>
      <span id="tierWrap" style="display:none;"> • Tier: <code id="tier"></code></span>
      <span id="scopesWrap" style="display:none;"> • Scopes: <code id="scopes"></code></span>
    </div>

    <div class="meta small stack">
      <span>Dev token:</span>
      <code id="tokState">(none)</code>
      <a class="btn" href="#" id="setTokBtn">Set token</a>
      <a class="btn" href="#" id="clearTokBtn">Clear token</a>
      <span class="small warn" id="tokHint" style="display:none;">Token is passed via <code>?token=...</code> for dev only.</span>
    </div>

    <div id="stats" class="small"></div>
    <div id="tracks"></div>

    <div class="meta small">
      Player uses <code>/api/catalog</code> and <code>/api/stream/&lt;track_id&gt;</code>. If you see 403s, check billing DB + token.
    </div>
  </div>

<script>
(function () {
  const elStatus = document.getElementById("status");
  const elTierWrap = document.getElementById("tierWrap");
  const elScopesWrap = document.getElementById("scopesWrap");
  const elTier = document.getElementById("tier");
  const elScopes = document.getElementById("scopes");
  const elStats = document.getElementById("stats");
  const elTracks = document.getElementById("tracks");
  const elTokState = document.getElementById("tokState");
  const elTokHint = document.getElementById("tokHint");
  const btnSetTok = document.getElementById("setTokBtn");
  const btnClearTok = document.getElementById("clearTokBtn");

  function qsToken() {
    const u = new URL(window.location.href);
    const t = u.searchParams.get("token");
    return t && t.trim() ? t.trim() : null;
  }

  function setQsToken(token) {
    const u = new URL(window.location.href);
    if (token && token.trim()) u.searchParams.set("token", token.trim());
    else u.searchParams.delete("token");
    window.location.href = u.toString();
  }

  function updateTokUI() {
    const t = qsToken();
    elTokState.textContent = t ? ("present (" + Math.min(t.length, 6) + " chars shown)") : "(none)";
    elTokHint.style.display = t ? "" : "none";
  }

  btnSetTok.addEventListener("click", (e) => {
    e.preventDefault();
    const t = window.prompt("Paste dev token (it will be set as ?token=...):", qsToken() || "");
    if (t == null) return;
    setQsToken(t);
  });

  btnClearTok.addEventListener("click", (e) => {
    e.preventDefault();
    setQsToken("");
  });

  updateTokUI();

  function apiUrl(path) {
    const t = qsToken();
    if (!t) return path;
    const u = new URL(path, window.location.origin);
    u.searchParams.set("token", t);
    return u.pathname + u.search;
  }

  async function apiGetJson(path) {
    const res = await fetch(apiUrl(path), {
      method: "GET",
      headers: {
        "Accept": "application/json",
      },
      credentials: "same-origin",
    });
    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch (_) {}
    return { ok: res.ok, status: res.status, data, text };
  }

  function setStatus(text, klass) {
    elStatus.innerHTML = "<code class='" + (klass || "") + "'>" + text + "</code>";
  }

  function showAccess(access) {
    if (!access) return;
    if (access.entitled) {
      setStatus("entitled", "");
    } else {
      setStatus("not entitled", "warn");
    }

    if (access.tier != null) {
      elTierWrap.style.display = "";
      elTier.textContent = access.tier;
    }
    if (Array.isArray(access.scopes)) {
      elScopesWrap.style.display = "";
      elScopes.textContent = access.scopes.join(",");
    }
  }

  function renderTracks(tracks) {
    elTracks.innerHTML = "";
    if (!tracks || !tracks.length) {
      elTracks.innerHTML = "<div class='card'>No tracks available for this token.</div>";
      return;
    }

    elStats.textContent = "tracks=" + tracks.length;

    for (const t of tracks) {
      const card = document.createElement("div");
      card.className = "card";

      const title = document.createElement("div");
      title.className = "row";
      title.innerHTML = `
        <div>
          <span class="title">${(t.index != null ? (t.index + 1) : "")}. ${t.title || t.track_id}</span>
        </div>
        <div class="small"><code>${t.track_id}</code></div>
      `;

      const audio = document.createElement("audio");
      audio.controls = true;

      const src = document.createElement("source");
      // Critical: stream via API so entitlements are enforced server-side
      src.src = apiUrl("/api/stream/" + encodeURIComponent(t.track_id));
      // Let the server decide; don't lie about mime type.
      src.type = "";
      audio.appendChild(src);

      const links = document.createElement("div");
      links.className = "small";
      const href = apiUrl("/api/stream/" + encodeURIComponent(t.track_id));
      links.innerHTML = `Stream: <a href="${href}">${href}</a>`;

      card.appendChild(title);
      card.appendChild(audio);
      card.appendChild(links);
      elTracks.appendChild(card);
    }
  }

  async function main() {
    // 1) Access snapshot
    const me = await apiGetJson("/api/me");
    if (!me.ok || !me.data) {
      setStatus("api/me failed (" + me.status + ")", "bad");
      elTracks.innerHTML = "<div class='card'><div class='small bad'>Failed to load /api/me.</div><pre class='small'></pre></div>";
      elTracks.querySelector("pre").textContent = me.text || "";
      return;
    }
    showAccess(me.data);

    // 2) Catalog
    const cat = await apiGetJson("/api/catalog");
    if (!cat.ok || !cat.data) {
      // show a clear hint (common errors: missing billing db, missing token, denied)
      const reason = (cat.data && cat.data.reason) ? String(cat.data.reason) : "";
      setStatus("api/catalog failed (" + cat.status + ")" + (reason ? (" • " + reason) : ""), "bad");
      elTracks.innerHTML = "<div class='card'><div class='small bad'>Failed to load /api/catalog.</div><pre class='small'></pre></div>";
      elTracks.querySelector("pre").textContent = cat.text || "";
      return;
    }

    const tracks = cat.data.tracks || [];
    renderTracks(tracks);
  }

  main().catch((e) => {
    setStatus("error", "bad");
    elTracks.innerHTML = "<div class='card'><div class='small bad'>Unhandled error.</div><pre class='small'></pre></div>";
    elTracks.querySelector("pre").textContent = String(e && e.stack ? e.stack : e);
  });
})();
</script>
</body>
</html>
